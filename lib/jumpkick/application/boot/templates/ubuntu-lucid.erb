bash -c '
echo "deb http://apt.opscode.com/ `lsb_release -cs`-0.10 main" | sudo tee /etc/apt/sources.list.d/opscode.list

sudo mkdir -p /etc/apt/trusted.gpg.d
gpg --fetch-key http://apt.opscode.com/packages@opscode.com.gpg.key
gpg --export packages@opscode.com | sudo tee /etc/apt/trusted.gpg.d/opscode-keyring.gpg > /dev/null

sudo apt-get -y update
sudo apt-get -y -o Dpkg::Options::="--force-confnew" install opscode-keyring

sudo apt-get -y upgrade

cat <<EOF | debconf-set-selections
chef chef/chef_server_url string http://<%= @config[:hostname] %>:4000
chef-solr chef-solr/amqp_password password <%= @config[:amqp_password] %>
chef-server-webui chef-server-webui/admin_password password <%= @config[:admin_password] %>
EOF

sudo apt-get -y install chef chef-server

mkdir -p ~/.chef
sudo cp /etc/chef/validation.pem /etc/chef/webui.pem ~/.chef
sudo chown -R $USER ~/.chef
'
